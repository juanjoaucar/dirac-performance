import streamlit as st
from pathlib import Path

import base64
import re
from collections import defaultdict



from comparison.loader import load_csvs, load_and_normalize
from comparison.tables import render_static_table, render_selection_table
from comparison.graphs import plot_selected_rows
from utils.explorer import build_categories, sidebar_selector
from utils.html_loader import load_html_as_data_url


# Configuración de la página
st.set_page_config(layout="wide")

# Carpeta raíz con los reportes
ROOT = Path("static/html")


# =============================================================================
# TEXTS
# =============================================================================

# Expander text
index_expander_content = """
This Streamlit application is designed to visualize DIRAC performance reports generated by diverse CPUs across a broad range of characteristics. In the sidebar, users can first select the CPU type and then choose different DIRAC builds, which vary in libraries, compilers, and compiler options. Each report includes:
- Main files that identify the key characteristics of the build under inspection.
- A summary table that briefly describes the performance tests and synthesizes their results.
- For each test, a Time vs. Number of cores graph (left) and a RAM vs. Number of cores graph (right).

The performance tests are executed individually on CPUs without other demanding processes active, ensuring the reliability of the results.
"""

# Disable links for imported Index.html files
disable_links_css = """
<style>
a {
    pointer-events: none; /* deshabilita clics */
    color: gray;          /* opcional: cambiar color para indicar que está deshabilitado */
    text-decoration: none;
    cursor: default;
}
</style>
"""



# =============================================================================
# Explorer sidebar
# =============================================================================

categorias = build_categories(ROOT)
# Ordenar categorías alfabéticamente
categorias_ordenadas = dict(sorted(categorias.items())) # TAL VEZ NO ES NECESARIO
sel_path = sidebar_selector(categorias_ordenadas, ROOT)

st.sidebar.write("### Comparison tool")
activar_comp = st.sidebar.checkbox("By CPU model", value=False)
activar_build_comp = st.sidebar.checkbox("By build type", value=False)

# Make sure only one tool is active
if activar_comp and activar_build_comp:
    st.sidebar.error("Please activate only one tool at a time.")
    st.stop()



# =============================================================================
# Tables and graphs (comparison tool)
# =============================================================================
import pandas as pd


if activar_comp:
    info = load_csvs(ROOT)
    cpus = sorted({cpu for cpu, build, p in info})
    builds = sorted({build for cpu, build, p in info})

    build_sel = st.sidebar.selectbox("Type of build", builds)
    cpus_sel = st.sidebar.multiselect("CPU Models:", cpus, default=None)

    if cpus_sel:
        st.write(f"## Comparison for build-type: **{build_sel}**")

        tablas = []

        for cpu in cpus_sel:
            match = [p for (cpu_i, build_i, p) in info
                     if cpu_i == cpu and build_i == build_sel]

            if not match:
                st.warning(f"There is no CSV file available for {cpu} and build-type {build_sel}")
                continue


            tablas.append(load_and_normalize(match[0], cpu, build_sel))

        ### =============================================================================
        ### Static table with data
        ### =============================================================================

        if tablas:
            import pandas as pd
            df_all = pd.concat(tablas, ignore_index=True)

            # ===============================
            # Static Table
            # ===============================
            df_sorted = (
                df_all[["Test", "cores", "CPU", "time [s]", "peak RAM [Mb]"]] # elijo 5 columnas
                .sort_values(["Test", "cores", "CPU"]) #las ordeno
            )

            render_static_table(df_sorted)

        # =============================================================================
        # Table to produce graphs for comparisson
        # =============================================================================

            sel = render_selection_table(df_sorted)

            if sel is not None and len(sel) > 0:
                plot_selected_rows(sel)
            else:
                st.info("Select desired rows to generate the graph for comparison.")


        st.stop()   # Avoid iframe loading

# =============================================================================
# Tables and graphs (comparison of builds for a single CPU)
# =============================================================================
import pandas as pd


if activar_build_comp:
    info = load_csvs(ROOT)
    cpus = sorted({cpu for cpu, build, p in info})
    builds = sorted({build for cpu, build, p in info})

    # Selecciono UN solo CPU
    cpu_sel = st.sidebar.selectbox("CPU Model:", cpus)

    # Selecciono VARIOS builds
    builds_sel = st.sidebar.multiselect("Build types:", builds, default=None)

    if builds_sel:
        st.write(f"## Comparison for CPU: **{cpu_sel}**")

        tablas = []

        for build in builds_sel:
            match = [p for (cpu_i, build_i, p) in info
                     if cpu_i == cpu_sel and build_i == build]

            if not match:
                st.warning(f"There is no CSV file available for CPU {cpu_sel} and build-type {build}")
                continue

            tablas.append(load_and_normalize(match[0], cpu_sel, build))

        ### =============================================================================
        ### Static table with data
        ### =============================================================================

        if tablas:
            df_all = pd.concat(tablas, ignore_index=True)

            # Orden y columnas elegidas
            df_sorted = (
                df_all[["Test", "cores", "CPU", "build", "time [s]", "peak RAM [Mb]"]]
                .sort_values(["Test", "cores", "build"])
            )

            render_static_table(df_sorted)

            # =============================================================================
            # Table to produce graphs for comparison
            # =============================================================================
            sel = render_selection_table(df_sorted)

            if sel is not None and len(sel) > 0:
                plot_selected_rows(sel, color_by="build")
            else:
                st.info("Select desired rows to generate the graph for comparison.")

        st.stop()   # Avoid iframe loading




# =============================================================================
#  HTML viewer
# =============================================================================
is_index = sel_path.name == "Index.html"
if is_index:
    st.expander("DIRAC performances reports", expanded=True).markdown(index_expander_content)

data_url = load_html_as_data_url(sel_path, is_index)
st.markdown(f'<iframe src="{data_url}" style="width:100%; height:2000px; border:none;"></iframe>', unsafe_allow_html=True)

